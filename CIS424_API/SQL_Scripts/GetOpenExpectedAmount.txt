/****** Object:  StoredProcedure [dbo].[sp_GetOpenExpectedAmount]    Script Date: 3/7/2024 11:47:54 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROCEDURE [dbo].[sp_GetOpenExpectedAmount]
	@usrID INT,
	@itemCounted VARCHAR(5)
AS
BEGIN
    SET NOCOUNT ON;

	 DECLARE @storeID INT;

    -- Get the storeID based on usrID
    SELECT @storeID = storeID
    FROM Users
    WHERE ID = @usrID;

    DECLARE @cashCountID INT;

    IF (@itemCounted = 'SAFE')
    BEGIN
        SELECT TOP 1 @cashCountID = c.ID
        FROM CashCount c
        JOIN Users u ON c.usrID = u.ID
        WHERE u.storeID = @storeID AND c.registerID = 0
        ORDER BY c.[date] DESC;
    END
    ELSE
    BEGIN
        SELECT TOP 1 @cashCountID = c.ID
        FROM CashCount c
        JOIN Register r ON c.registerID = r.ID
        JOIN Users u ON r.storeID = u.storeID
        WHERE u.ID = @usrID AND r.name = @itemCounted
        ORDER BY c.[date] DESC;
    END

    SELECT ISNULL(total, 0)
    FROM Totals
    WHERE cashCountID = @cashCountID;
END;
GO

